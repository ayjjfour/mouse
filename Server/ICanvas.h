#ifndef _ICANVAS_H_
#define _ICANVAS_H_

#include "ITrace.h"
///	Blit 样式
/////////////////////////

#define BLIT_NORMAL	0				//正常的BLIT，不考虑透明色与Alpha
#define BLIT_COPY	0				//同上
#define BLIT_ADDITIVE	0x1			//色彩迭加
#define BLIT_SUBTRACT	0x2			//色彩衰减
#define BLIT_TRANS		0x3			//alpha BLIT
#define BLIT_MASK		0x4			//透明色BLIT
#define BLIT_BACK		0x5			//反向COPY 即目标到源
#define BLIT_XOR		0x4			

#define FONT_ALPHA		0
#define FONT_NOALPHA	1
//////////////////////////

#pragma pack (push)
#pragma pack (1)

//16位点结构
struct WPixel {
	union {
		WORD color;								// 16bit 高彩
		struct {
			WORD blue:5;						// 5bit 兰色
			WORD green:6;						// 6bit 绿色
			WORD red:5;							// 5bit 红色
		};
	};
	WPixel() {}
	WPixel(DWORD c) {color=(WORD)((c>>8&0xf800)|(c>>5&0x7e0)|(c>>3&0x1f));}	//从DWORD转换
	WPixel(int r,int g,int b) : red(r>>3),green(g>>2),blue(b>>3) {}
	operator DWORD() const {return (color<<5&0x7fc00)|(color<<8&0xf80000)|((color<<3|(color&7))&0x3ff);}
};

#pragma pack (pop)


struct ITTFont;
struct IAlphaBitmap;

struct IBitmap
{
	//初始化函数
	virtual BOOL Create(int nWidth, int nHeight) = NULL;		//创建位图
	virtual BOOL Create(int nWidth, int nHeight, void* ptr) = NULL;	//给定数据区创建位图
	virtual BOOL Create(IBitmap* parent, int x, int y, int nWidth, int nHeight) = NULL; //从父位图上创建对象
	virtual IBitmap* SubBitmap(int x, int y, int nWidth, int nHeight) = NULL;	//创建子位图

	virtual int GetWidth() const = NULL;		//获得宽度
	virtual int GetHeight() const = NULL;		//获得高度

	//绘图相关
	virtual BOOL Clear(WPixel clr, RECT* pRc = NULL) = NULL;	//清屏
	virtual BOOL Draw(int dx, int dy, IBitmap* bmp, DWORD dwStyle = BLIT_NORMAL) = NULL;//把别的位图绘制到此位图
	virtual BOOL Draw(int dx, int dy, int w, int h, IBitmap* bmp, int sx, int sy, DWORD dwStyle = BLIT_NORMAL) = NULL; //增强的Draw
	virtual BOOL DrawAlpha(int dx, int dy, IAlphaBitmap* bmp, DWORD dwStyle = BLIT_COPY) = NULL;//把别的位图绘制到此位图
	virtual BOOL DrawAlpha(int dx, int dy, int w, int h, IAlphaBitmap* bmp, int sx, int sy, DWORD dwStyle = BLIT_COPY) = NULL; //增强的AlphaDraw
	
	virtual void Draw(int x, int y, const char* s, WPixel clr) = NULL; //打印ASCII字符
	virtual BOOL DrawBox(RECT& rc, WPixel clr, DWORD dwStyle = BLIT_NORMAL, int alpha = 255) = NULL;
	virtual BOOL DrawLine(POINT& ptFrom, POINT& ptTo, WPixel clr, DWORD dwStyle = BLIT_NORMAL, int alpha = 255) = NULL;

	virtual BOOL Blit2DC(HDC hDC,int dx,int dy,int x,int y,int w,int h)  = NULL;	// BLIT 一个矩形部分到 DC
	//其它
	virtual WPixel* operator[](int y)  const = NULL;		// 返回一个扫描行指针
	virtual void* GetBmpStruct() const = NULL;		//返回数据
	
	
	virtual BOOL Load(void *bmpdata) = NULL;				// 从数据区读出位图
	virtual BOOL Save(const char *filename) const = NULL;	//保存位图

	virtual void SetUserData(DWORD userdata) = NULL;				// 设置用户数据
	virtual DWORD GetUserData() const = NULL;		//得到用户数据

	
	virtual BOOL IsValid() const = NULL;	//是否为有效
	virtual void Release() = NULL;
	virtual void SetData(void*p) = NULL;	//更换内部的数据

	virtual BOOL Scroll(int x, int y) = NULL;	//整个Bitmap滚动
	virtual BOOL DrawText(ITTFont*,int x, int y, const char* str, WPixel color, DWORD style=FONT_ALPHA) = NULL;	//输出TTF文字
	virtual BOOL IsTransparent(POINT& ptSelect) = NULL; // 测试某个点是否透明，add by PeakGao in 2002.10.22
	//从本位图上创建一个独立的Tile子位图(即菱形格位图, ptLeftTop为菱形格的左顶点)
	virtual IBitmap* SubTile(POINT ptLeftTop) = NULL;
	virtual BOOL LoadEx(void* customdata) = NULL;
};

struct IAlphaBitmap : public IBitmap
{
	virtual BOOL LoadTGA(const void *tgadata) = NULL;		//加载TGA图片
	virtual BOOL SaveTGA(const char *filename) const = NULL;	//存为32位TGA
	virtual BYTE* ChannelLine(int y) const = NULL;				//得到通道指针
	virtual void ClearChannel(int alpha) = NULL;				// 清除 Alpha Channel
	virtual BOOL Combine(IAlphaBitmap* bmp) = NULL;				//合并二个AlphaBitmap
	virtual BOOL Load2Bmp(const void* bmpdata, const void* alphadata) = NULL;	//从二张Bitmap中生成AlphaBitmap，后一张是通道图，只能为256色
	virtual BOOL Load2BmpEx(IBitmap* pBmp, int nBmpX, int nBmpY,
							IBitmap* pAlpha, int nAlphaX, int nAlphaY,
							int nWidth, int nHeight) = NULL; // 从两个IBitmap中生成AlphaBitmap，后一张是通道图，只能为256色	
};

struct ICanvas : public IBitmap
{
	//与IBitmap的交互
	virtual IBitmap* SelectBitmap(IBitmap* pBitmap) = NULL;		//选择一个IBitmap
	virtual IBitmap* GetBitmap(void) const = NULL;
	
	//与Canvas的交互
	virtual BOOL Draw(int x, int y, ICanvas* pCanvas, DWORD dwStyle = BLIT_NORMAL) = NULL;	//把别的位图绘制到此位图
	virtual BOOL Draw(int x, int y, IBitmap* bmp, DWORD dwStyle = BLIT_NORMAL) = NULL;	//把别的位图绘制到此位图
	virtual BOOL Draw(int dx, int dy, int w, int h, IBitmap* bmp, int sx, int sy, DWORD dwStyle = BLIT_NORMAL) = NULL; //增强的Draw
	virtual BOOL Draw(int dx, int dy, int w, int h, ICanvas* bmp, int sx, int sy, DWORD dwStyle = BLIT_NORMAL) = NULL; //增强的Draw
	virtual BOOL Update2DC(HDC hDC,int dx,int dy,int x,int y,int w,int h) = NULL;	// BLIT 一个矩形部分到 DC
	virtual void Draw(int x, int y, const char* s, WPixel clr) = NULL; //打印ASCII字符

	//脏矩形与覆盖矩形管理
	//入脏矩形管理
	virtual void AddDirtyRect(RECT& area) = NULL;
	virtual void AddDirtyRect(int x, int y, int w, int h) = NULL;

	virtual void AddInOutRect(RECT& area) = NULL;
	
	virtual void AddInOutWholeScreen() = NULL;
	virtual void AddInOutOverlay(RECT& area) = NULL;

	virtual void AddOverlay(RECT& area) = NULL;
	virtual void ResetDirtyRect(void) = NULL;		//把所有矩形清0
	virtual void AddWholeScreen(void) = NULL;
	virtual void Merge(void) = NULL;

	virtual void* GetDirtyList() = NULL;
	virtual void AddDirtyList(void* pList) = NULL;
	virtual BOOL IsInDirty(RECT& rc) = NULL;


	//出脏矩形管理
	virtual void AddOutDirtyRect(RECT& area) = NULL;
	virtual void AddOutDirtyRect(int x, int y, int w, int h) = NULL;
	virtual void AddOutOverlay(RECT& area) = NULL;
	virtual void ResetOutDirtyRect(void) = NULL;		//把所有矩形清 0
	virtual void AddOutWholeScreen(void) = NULL;
	virtual void MergeOut(void) = NULL;

	virtual void* GetOutDirtyList() = NULL;
	virtual void AddOutDirtyList(void* pList) = NULL;

	virtual BOOL IsInEqualOut() = NULL;			//入脏矩形是否与出脏矩形相等
	virtual void SetInEqualOut(BOOL) = NULL;	
	virtual BOOL IsOutDirty(RECT& rc) = NULL;	
	
	virtual void DrawDirtyList(ICanvas* pICanvas,WPixel color) = NULL;
	virtual void DrawOutDirtyList(ICanvas *pICanvas, WPixel color) = NULL;

};

struct ITTFont
{
	virtual BOOL Create(HFONT font, int alpha = 16, int cachesize = 128) = NULL;
	virtual void* GetChar(unsigned int c) = NULL;	// 获取一个字的数据

	virtual int GetHeight() const = NULL;		// 获取字体高度
	
	virtual void Lock() = NULL;				// Lock Cache Buffer (不可删减)
	virtual void UnLock() = NULL;			// Unlock Cache Buffer

	virtual DWORD GetLength(const char* str) = NULL;	//得到字符串的长度
	virtual DWORD GetCharLength(const WORD c) = NULL;	//得到一个字的长度
	

	virtual void Release() = NULL;
	
};

/*
#ifdef CANVAS_EXPORTS

extern "C" __declspec(dllexport) BOOL CreateIBitmap(DWORD dwVersion, IBitmap** ppIBitmap, ITrace* pTrace = NULL);
extern "C" __declspec(dllexport) BOOL CreateICanvas(DWORD dwVersion, ICanvas** ppICanvas, ITrace* pTrace = NULL);

#else

extern "C" __declspec(dllimport) BOOL CreateIBitmap(DWORD dwVersion, IBitmap** ppIBitmap, ITrace* pTrace = NULL);
extern "C" __declspec(dllimport) BOOL CreateICanvas(DWORD dwVersion, ICanvas** ppICanvas, ITrace* pTrace = NULL);

#endif //CANVAS_EXPORTS
*/
class ICanvasHelper
{
	typedef BOOL (*ProcCreateIBitmap)(DWORD dwVersion, IBitmap** ppIBitmap, ITrace* pTrace = NULL);
	typedef BOOL (*ProcCreateICanvas)(DWORD dwVersion, ICanvas** ppICanvas, ITrace* pTrace = NULL);
	typedef BOOL (*ProcCreateITTFont)(DWORD dwVersion, ITTFont** ppITTFont, ITrace* pTrace = NULL);
	typedef BOOL (*ProcCreateIAlphaBitmap)(DWORD dwVersion, IAlphaBitmap** ppIBitmap, ITrace* pTrace = NULL);
public:
	
	ICanvasHelper() : m_hdll(0){}
	~ICanvasHelper()
	{
		if(m_hdll)
			FreeLibrary(m_hdll);
	}

	void LoadDLL()
	{
#ifdef _DEBUG
		m_hdll = LoadLibrary("Canvasd.dll");
#else
		m_hdll = LoadLibrary("Canvas.dll");
#endif
		
		if(m_hdll == NULL)
			throw "Can not load Canvas.dll";
	}

	BOOL CreateIBitmap(IBitmap** ppIBitmap, ITrace* pTrace = NULL)
	{
		try
		{
			if(m_hdll == NULL)
			{
				LoadDLL();
			}

			ProcCreateIBitmap proc;
			proc = (ProcCreateIBitmap)GetProcAddress(m_hdll, "CreateIBitmap");

			if(proc == NULL)
				throw "Can not Get CreateIBitmap!";

			return proc(1, ppIBitmap, pTrace);
		}
		catch(LPCSTR szMsg)
		{
			OutputDebugString(szMsg);
			return FALSE;
		}

		catch(...)
		{
			return FALSE;
		}
	}

	BOOL CreateIAlphaBitmap(IAlphaBitmap** ppIBitmap, ITrace* pTrace = NULL)
	{
		try
		{
			if(m_hdll == NULL)
			{
				LoadDLL();
			}

			ProcCreateIAlphaBitmap proc;
			proc = (ProcCreateIAlphaBitmap)GetProcAddress(m_hdll, "CreateIAlphaBitmap");

			if(proc == NULL)
				throw "Can not Get CreateIBitmap!";

			return proc(1, ppIBitmap, pTrace);
		}
		catch(LPCSTR szMsg)
		{
			OutputDebugString(szMsg);
			return FALSE;
		}

		catch(...)
		{
			return FALSE;
		}
	}

	BOOL CreateICanvas(ICanvas** ppICanvas, ITrace* pTrace = NULL)
	{
		try
		{
			if(m_hdll == NULL)
			{
				LoadDLL();
			}

			ProcCreateICanvas proc;
			proc = (ProcCreateICanvas)GetProcAddress(m_hdll, "CreateICanvas");

			if(proc == NULL)
				throw "Can not Get CreateICanvas!";

			return proc(1, ppICanvas, pTrace);
		}
		catch(LPCSTR szMsg)
		{
			OutputDebugString(szMsg);
			return FALSE;
		}

		catch(...)
		{
			return FALSE;
		}
	}

	BOOL CreateITTFont(ITTFont** ppITTFont, ITrace* pTrace = NULL)
	{
		try
		{
			if(m_hdll == NULL)
			{
				LoadDLL();
			}

			ProcCreateITTFont proc;
			proc = (ProcCreateITTFont)GetProcAddress(m_hdll, "CreateITTFont");

			if(proc == NULL)
				throw "Can not Get CreateITTFont!";

			return proc(1, ppITTFont, pTrace);
		}
		catch(LPCSTR szMsg)
		{
			OutputDebugString(szMsg);
			return FALSE;
		}

		catch(...)
		{
			return FALSE;
		}
	}

private:
	HINSTANCE m_hdll;

};


////////////////////////////////////////////////////////////////////////////
#endif //_ICANVAS_H
